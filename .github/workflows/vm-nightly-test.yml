name: VM Nightly
on:
  schedule:
    - cron: 0 0 * * *
  workflow_dispatch:

env:
  cwd: ${{github.workspace}}/packages/vm

defaults:
  run:
    working-directory: packages/vm

jobs:
  test-vm-api:
    if: github.repository == 'ethereumjs/ethereumjs-monorepo'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - uses: actions/setup-node@v6
        with:
          node-version: 24
          cache: 'npm'
      
      - name: Install Dependencies
        run: npm ci
        working-directory: ${{github.workspace}}

      - run: npm run test:API
  #     - run: npm run test:API:browser

  test-vm-state:
    if: github.repository == 'ethereumjs/ethereumjs-monorepo'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        fork:
          [
            'Prague',
            'Chainstart',
            'Homestead',
            'dao',
            'TangerineWhistle',
            'SpuriousDragon',
            'Byzantium',
            'Constantinople',
            'Petersburg',
            'Istanbul',
            'MuirGlacier',
            'Berlin',
            'London',
            'Paris',
            'Shanghai',
            'Cancun',
            'ByzantiumToConstantinopleFixAt5',
            'EIP158ToByzantiumAt5',
            'FrontierToHomesteadAt5',
            'HomesteadToDaoAt5',
            'HomesteadToEIP150At5',
            'BerlinToLondonAt5',
          ]
      fail-fast: false
    steps:
      - uses: actions/checkout@v5

      - uses: actions/setup-node@v6
        with:
          node-version: 24
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci
        working-directory: ${{github.workspace}}

      - uses: actions/cache/restore@v4
        id: submodules-cache
        with:
          path: ${{github.workspace}}/packages/ethereum-tests
          key: ethereum-tests-${{ hashFiles('.gitmodules') }}-${{ github.sha }}

      - name: Initialize submodules (if not cached)
        if: steps.submodules-cache.outputs.cache-hit != 'true'
        run: git submodule update --init --recursive

      - run: VITE_FORK=${{ matrix.fork }} VITE_VERIFY_TEST_AMOUNT_ALL_TESTS=1 npx vitest run --passWithNoTests test/tester/state.spec.ts

  test-vm-blockchain:
    if: github.repository == 'ethereumjs/ethereumjs-monorepo'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        fork:
          [
            'Prague',
            'Chainstart',
            'Homestead',
            'dao',
            'TangerineWhistle',
            'SpuriousDragon',
            'Byzantium',
            'Constantinople',
            'Petersburg',
            'Istanbul',
            'MuirGlacier',
            'Berlin',
            'London',
            'Paris',
            'Shanghai',
            'Cancun',
            'ByzantiumToConstantinopleFixAt5',
            'EIP158ToByzantiumAt5',
            'FrontierToHomesteadAt5',
            'HomesteadToDaoAt5',
            'HomesteadToEIP150At5',
            'BerlinToLondonAt5',
          ]
      fail-fast: false
    steps:
      - uses: actions/checkout@v5

      - uses: actions/setup-node@v6
        with:
          node-version: 24
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci
        working-directory: ${{github.workspace}}

      - uses: actions/cache/restore@v4
        id: submodules-cache
        with:
          path: ${{github.workspace}}/packages/ethereum-tests
          key: ethereum-tests-${{ hashFiles('.gitmodules') }}-${{ github.sha }}

      - name: Initialize submodules (if not cached)
        if: steps.submodules-cache.outputs.cache-hit != 'true'
        run: git submodule update --init --recursive

      - run: VITE_FORK=${{ matrix.fork }} VITE_VERIFY_TEST_AMOUNT_ALL_TESTS=1 npx vitest run --passWithNoTests test/tester/blockchain.spec.ts

  test-vm-slow:
    if: github.repository == 'ethereumjs/ethereumjs-monorepo'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        testFile:
          [
            '^Call50000_sha256',
            '^CALLBlake2f_MaxRounds',
            '^Return50000',
            '^Return50000_2',
            '^static_Call50000_sha256',
            '^loopMul',
            '^loopExp',
          ]
      fail-fast: false
    steps:
      - uses: actions/checkout@v5

      - uses: actions/setup-node@v6
        with:
          node-version: 24
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci
        working-directory: ${{github.workspace}}

      - uses: actions/cache/restore@v4
        id: submodules-cache
        with:
          path: ${{github.workspace}}/packages/ethereum-tests
          key: ethereum-tests-${{ hashFiles('.gitmodules') }}-${{ github.sha }}

      - name: Initialize submodules (if not cached)
        if: steps.submodules-cache.outputs.cache-hit != 'true'
        run: git submodule update --init --recursive

      - run: VITE_FILE=${{ matrix.testFile }} VITE_RUN_SKIPPED=slow npx vitest run test/tester/state.spec.ts
